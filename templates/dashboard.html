<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Summarizer & Auto-Responder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .email-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .email-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-pending { border-left-color: #ffc107; }
        .status-approved { border-left-color: #28a745; }
        .status-rejected { border-left-color: #dc3545; }
        .status-sent { border-left-color: #17a2b8; }
        .intent-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .tone-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .email-body {
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reply-textarea {
            min-height: 120px;
            resize: vertical;
        }
        .modal-xl {
            max-width: 90%;
        }
        .loading {
            display: none;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-envelope-open-text me-2"></i>
                Email Summarizer & Auto-Responder
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm" onclick="processEmails()">
                    <i class="fas fa-sync-alt me-1"></i> Process Emails
                </button>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="checkHealth()">
                    <i class="fas fa-heartbeat me-1"></i> Health Check
                </button>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="showSchedulerModal()">
                    <i class="fas fa-clock me-1"></i> Scheduler
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-inbox me-2"></i>Email Dashboard
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshPage()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if emails %}
                            <div class="row">
                                {% for email in emails %}
                                <div class="col-12 mb-3">
                                    <div class="card email-card status-{{ email.status.value }}">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <h6 class="card-title text-truncate" title="{{ email.subject }}">
                                                        <i class="fas fa-envelope me-1"></i>{{ email.subject }}
                                                    </h6>
                                                    <p class="text-muted small mb-1">
                                                        <i class="fas fa-user me-1"></i>{{ email.sender }}
                                                    </p>
                                                    <p class="text-muted small mb-2">
                                                        <i class="fas fa-clock me-1"></i>
                                                        {{ email.timestamp.strftime('%Y-%m-%d %H:%M') if email.timestamp else 'N/A' }}
                                                    </p>
                                                    {% if email.intent %}
                                                    <span class="badge bg-info intent-badge">
                                                        <i class="fas fa-tag me-1"></i>{{ email.intent.value }}
                                                    </span>
                                                    {% endif %}
                                                    {% if email.tone %}
                                                    <span class="badge bg-secondary tone-badge">
                                                        <i class="fas fa-volume-up me-1"></i>{{ email.tone.value }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="email-body">
                                                        <strong>Summary:</strong><br>
                                                        {{ email.summary or 'No summary available' }}
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="reply-textarea">
                                                        <strong>Draft Reply:</strong><br>
                                                        <textarea class="form-control form-control-sm" rows="3" 
                                                                id="reply-{{ email.id }}">{{ email.draft_reply or '' }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <div class="d-flex flex-column gap-1">
                                                        <select class="form-select form-select-sm" id="tone-{{ email.id }}">
                                                            {% for tone in tones %}
                                                            <option value="{{ tone.value }}" 
                                                                    {% if email.tone and email.tone.value == tone.value %}selected{% endif %}>
                                                                {{ tone.value }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                        <select class="form-select form-select-sm" id="status-{{ email.id }}">
                                                            {% for status in status_options %}
                                                            <option value="{{ status }}" 
                                                                    {% if email.status.value == status %}selected{% endif %}>
                                                                {{ status.title() }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary" 
                                                                    onclick="regenerateReply({{ email.id }})"
                                                                    title="Regenerate Reply">
                                                                <i class="fas fa-magic"></i>
                                                            </button>
                                                            <button class="btn btn-outline-success" 
                                                                    onclick="updateEmail({{ email.id }})"
                                                                    title="Update Email">
                                                                <i class="fas fa-save"></i>
                                                            </button>
                                                            <button class="btn btn-outline-info" 
                                                                    onclick="viewEmail({{ email.id }})"
                                                                    title="View Details">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" 
                                                                    onclick="sendEmail({{ email.id }})"
                                                                    title="Send Email"
                                                                    {% if email.status.value == 'sent' %}disabled{% endif %}>
                                                                <i class="fas fa-paper-plane"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No emails found</h5>
                                <p class="text-muted">New emails will appear here once processed.</p>
                                <button class="btn btn-primary" onclick="processEmails()">
                                    <i class="fas fa-sync-alt me-1"></i>Process Emails
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Detail Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Email Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="emailModalBody">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduler Control Modal -->
    <div class="modal fade" id="schedulerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clock me-2"></i>Scheduler Control
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="schedulerStatus">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="startScheduler()">
                        <i class="fas fa-play me-1"></i>Start
                    </button>
                    <button type="button" class="btn btn-warning" onclick="stopScheduler()">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                    <button type="button" class="btn btn-info" onclick="restartScheduler()">
                        <i class="fas fa-redo me-1"></i>Restart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="loadingToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <strong class="me-auto">Processing</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="loadingMessage">
                Please wait...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let emailModal;
        let loadingToast;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
            loadingToast = new bootstrap.Toast(document.getElementById('loadingToast'));
        });

        // Show loading message
        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            loadingToast.show();
        }

        // Hide loading message
        function hideLoading() {
            loadingToast.hide();
        }

        // Process emails
        async function processEmails() {
            try {
                showLoading('Processing emails...');
                const response = await fetch('/process-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    throw new Error('Failed to process emails');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing emails: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update email
        async function updateEmail(emailId) {
            try {
                const draftReply = document.getElementById(`reply-${emailId}`).value;
                const tone = document.getElementById(`tone-${emailId}`).value;
                const status = document.getElementById(`status-${emailId}`).value;

                showLoading('Updating email...');
                
                const formData = new FormData();
                formData.append('draft_reply', draftReply);
                formData.append('tone', tone);
                formData.append('status', status);

                const response = await fetch(`/update-email/${emailId}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Email updated:', result.message);
                } else {
                    throw new Error('Failed to update email');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating email: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Regenerate reply
        async function regenerateReply(emailId) {
            try {
                const tone = document.getElementById(`tone-${emailId}`).value;
                
                showLoading('Regenerating reply...');
                
                const formData = new FormData();
                formData.append('tone', tone);

                const response = await fetch(`/regenerate-reply/${emailId}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById(`reply-${emailId}`).value = result.new_reply;
                    console.log('Reply regenerated:', result.message);
                } else {
                    throw new Error('Failed to regenerate reply');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error regenerating reply: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Send email
        async function sendEmail(emailId) {
            if (!confirm('Are you sure you want to send this email?')) {
                return;
            }

            try {
                showLoading('Sending email...');
                
                const response = await fetch(`/send-email/${emailId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Email sent:', result.message);
                    location.reload();
                } else {
                    throw new Error('Failed to send email');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending email: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // View email details
        async function viewEmail(emailId) {
            try {
                showLoading('Loading email details...');
                
                const response = await fetch(`/email/${emailId}`);
                
                if (response.ok) {
                    const email = await response.json();
                    
                    const modalBody = document.getElementById('emailModalBody');
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Original Email</h6>
                                <p><strong>From:</strong> ${email.sender}</p>
                                <p><strong>Subject:</strong> ${email.subject}</p>
                                <p><strong>Intent:</strong> ${email.intent || 'Not classified'}</p>
                                <p><strong>Summary:</strong></p>
                                <div class="border p-2 bg-light">
                                    ${email.summary || 'No summary available'}
                                </div>
                                <p><strong>Body:</strong></p>
                                <div class="border p-2 bg-light" style="max-height: 300px; overflow-y: auto;">
                                    ${email.body.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Draft Reply</h6>
                                <p><strong>Tone:</strong> ${email.tone || 'Not set'}</p>
                                <p><strong>Status:</strong> ${email.status}</p>
                                <p><strong>Reply:</strong></p>
                                <div class="border p-2 bg-light">
                                    ${email.draft_reply ? email.draft_reply.replace(/\n/g, '<br>') : 'No draft reply'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    emailModal.show();
                } else {
                    throw new Error('Failed to load email details');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading email details: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Check health
        async function checkHealth() {
            try {
                showLoading('Checking system health...');
                
                const response = await fetch('/health');
                
                if (response.ok) {
                    const health = await response.json();
                    console.log('Health check:', health);
                    
                    let message = 'System Status:\n';
                    message += `Email Client: ${health.email_client ? '✅' : '❌'}\n`;
                    message += `AI Service: ${health.ai_service ? '✅' : '❌'}\n`;
                    message += `Scheduler: ${health.scheduler ? '✅' : '❌'}`;
                    
                    alert(message);
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error checking health: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Refresh page
        function refreshPage() {
            location.reload();
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshPage, 30000);

        // Scheduler control functions
        let schedulerModal;

        // Show scheduler modal
        function showSchedulerModal() {
            if (!schedulerModal) {
                schedulerModal = new bootstrap.Modal(document.getElementById('schedulerModal'));
            }
            schedulerModal.show();
            loadSchedulerStatus();
        }

        // Load scheduler status
        async function loadSchedulerStatus() {
            try {
                showLoading('Loading scheduler status...');
                
                const response = await fetch('/scheduler/status');
                
                if (response.ok) {
                    const status = await response.json();
                    displaySchedulerStatus(status);
                } else {
                    throw new Error('Failed to load scheduler status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading scheduler status: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display scheduler status
        function displaySchedulerStatus(status) {
            const statusDiv = document.getElementById('schedulerStatus');
            
            let statusHtml = `
                <div class="row">
                    <div class="col-12">
                        <h6>Scheduler Status</h6>
                        <div class="alert alert-${status.enabled && status.running ? 'success' : 'warning'}">
                            <i class="fas fa-${status.enabled && status.running ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                            <strong>Status:</strong> ${status.enabled && status.running ? 'Running' : 'Stopped'}
                        </div>
                        
                        <h6>Configuration</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Type:</span>
                                <span class="badge bg-primary">${status.type || 'N/A'}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Morning Time:</span>
                                <span>${status.morning_time || 'N/A'}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Evening Time:</span>
                                <span>${status.evening_time || 'N/A'}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Interval (minutes):</span>
                                <span>${status.interval_minutes || 'N/A'}</span>
                            </li>
                        </ul>
                        
                        <h6>Scheduled Jobs</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Name</th>
                                        <th>Next Run</th>
                                        <th>Trigger</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            if (status.jobs && status.jobs.length > 0) {
                status.jobs.forEach(job => {
                    statusHtml += `
                        <tr>
                            <td><code>${job.id}</code></td>
                            <td>${job.name}</td>
                            <td>${job.next_run ? new Date(job.next_run).toLocaleString() : 'N/A'}</td>
                            <td><small>${job.trigger}</small></td>
                        </tr>
                    `;
                });
            } else {
                statusHtml += `
                    <tr>
                        <td colspan="4" class="text-center text-muted">No scheduled jobs</td>
                    </tr>
                `;
            }
            
            statusHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            statusDiv.innerHTML = statusHtml;
        }

        // Start scheduler
        async function startScheduler() {
            try {
                showLoading('Starting scheduler...');
                
                const response = await fetch('/scheduler/start', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Scheduler started:', result.message);
                    loadSchedulerStatus(); // Refresh status
                } else {
                    throw new Error('Failed to start scheduler');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting scheduler: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Stop scheduler
        async function stopScheduler() {
            try {
                showLoading('Stopping scheduler...');
                
                const response = await fetch('/scheduler/stop', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Scheduler stopped:', result.message);
                    loadSchedulerStatus(); // Refresh status
                } else {
                    throw new Error('Failed to stop scheduler');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error stopping scheduler: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Restart scheduler
        async function restartScheduler() {
            try {
                showLoading('Restarting scheduler...');
                
                const response = await fetch('/scheduler/restart', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Scheduler restarted:', result.message);
                    loadSchedulerStatus(); // Refresh status
                } else {
                    throw new Error('Failed to restart scheduler');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error restarting scheduler: ' + error.message);
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html> 